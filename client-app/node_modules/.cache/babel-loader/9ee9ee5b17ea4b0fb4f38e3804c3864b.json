{"ast":null,"code":"import _regeneratorRuntime from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _asyncToGenerator from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/toConsumableArray\";import _initializerDefineProperty from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/initializerDefineProperty\";import _classCallCheck from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _applyDecoratedDescriptor from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/applyDecoratedDescriptor\";import _initializerWarningHelper from\"C:\\\\Projects\\\\Reactivities\\\\client-app\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/initializerWarningHelper\";var _dec,_class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_descriptor11,_descriptor12,_descriptor13,_descriptor14,_descriptor15,_descriptor16,_descriptor17,_descriptor18,_descriptor19,_descriptor20,_descriptor21,_descriptor22,_descriptor23,_temp;import{observable,action,computed,runInAction,reaction,toJS}from\"mobx\";import agent from\"../api/agent\";import{history}from\"../..\";import{toast}from\"react-toastify\";import{setActivityProps,createAttendee}from\"../common/util/util\";import{HubConnectionBuilder,LogLevel}from\"@aspnet/signalr\";var LIMIT=2;;var ActivityStore=(_dec=observable.ref,(_class=(_temp=/*#__PURE__*/function(){function ActivityStore(rootStore){var _this=this;_classCallCheck(this,ActivityStore);this.rootStore=void 0;_initializerDefineProperty(this,\"activityRegistry\",_descriptor,this);_initializerDefineProperty(this,\"activity\",_descriptor2,this);_initializerDefineProperty(this,\"loadingInitial\",_descriptor3,this);_initializerDefineProperty(this,\"submitting\",_descriptor4,this);_initializerDefineProperty(this,\"target\",_descriptor5,this);_initializerDefineProperty(this,\"loading\",_descriptor6,this);_initializerDefineProperty(this,\"hubConnection\",_descriptor7,this);_initializerDefineProperty(this,\"activityCount\",_descriptor8,this);_initializerDefineProperty(this,\"page\",_descriptor9,this);_initializerDefineProperty(this,\"predicate\",_descriptor10,this);_initializerDefineProperty(this,\"setPredicate\",_descriptor11,this);_initializerDefineProperty(this,\"setPage\",_descriptor12,this);_initializerDefineProperty(this,\"createHubConnection\",_descriptor13,this);_initializerDefineProperty(this,\"stopHubConnection\",_descriptor14,this);_initializerDefineProperty(this,\"addComment\",_descriptor15,this);_initializerDefineProperty(this,\"loadActivities\",_descriptor16,this);_initializerDefineProperty(this,\"loadActivity\",_descriptor17,this);_initializerDefineProperty(this,\"clearActivity\",_descriptor18,this);this.getActivity=function(id){return _this.activityRegistry.get(id);};_initializerDefineProperty(this,\"createActivity\",_descriptor19,this);_initializerDefineProperty(this,\"editActivity\",_descriptor20,this);_initializerDefineProperty(this,\"deleteActivity\",_descriptor21,this);_initializerDefineProperty(this,\"attendActivity\",_descriptor22,this);_initializerDefineProperty(this,\"cancelAttendance\",_descriptor23,this);this.rootStore=rootStore;reaction(function(){return _this.predicate.keys();},function(){_this.page=0;_this.activityRegistry.clear();_this.loadActivities();});}_createClass(ActivityStore,[{key:\"groupActivitiesByDate\",value:function groupActivitiesByDate(activities){var sortedActivities=activities.sort(function(a,b){return a.date.getTime()-b.date.getTime();});return Object.entries(sortedActivities.reduce(function(activities,activity){var date=activity.date.toISOString().split(\"T\")[0];activities[date]=activities[date]?[].concat(_toConsumableArray(activities[date]),[activity]):[activity];return activities;},{}));}},{key:\"axiosParams\",get:function get(){var params=new URLSearchParams();params.append('limit',String(LIMIT));params.append('offset',\"\".concat(this.page?this.page*LIMIT:0));this.predicate.forEach(function(value,key){if(key==='startDate'){params.append(key,value.toISOString());}else{params.append(key,value);}});return params;}},{key:\"totalPages\",get:function get(){return Math.ceil(this.activityCount/LIMIT);}},{key:\"activitiesByDate\",get:function get(){return this.groupActivitiesByDate(Array.from(this.activityRegistry.values()));}}]);return ActivityStore;}(),_temp),(_descriptor=_applyDecoratedDescriptor(_class.prototype,\"activityRegistry\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return new Map();}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,\"activity\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return null;}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,\"loadingInitial\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return false;}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,\"submitting\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return false;}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,\"target\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return\"\";}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,\"loading\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return false;}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,\"hubConnection\",[_dec],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return null;}}),_descriptor8=_applyDecoratedDescriptor(_class.prototype,\"activityCount\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return 0;}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,\"page\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return 0;}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,\"predicate\",[observable],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){return new Map();}}),_descriptor11=_applyDecoratedDescriptor(_class.prototype,\"setPredicate\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this2=this;return function(predicate,value){_this2.predicate.clear();if(predicate!=='all'){_this2.predicate.set(predicate,value);}};}}),_applyDecoratedDescriptor(_class.prototype,\"axiosParams\",[computed],Object.getOwnPropertyDescriptor(_class.prototype,\"axiosParams\"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,\"totalPages\",[computed],Object.getOwnPropertyDescriptor(_class.prototype,\"totalPages\"),_class.prototype),_descriptor12=_applyDecoratedDescriptor(_class.prototype,\"setPage\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this3=this;return function(page){_this3.page=page;};}}),_descriptor13=_applyDecoratedDescriptor(_class.prototype,\"createHubConnection\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this4=this;return function(){_this4.hubConnection=new HubConnectionBuilder().withUrl(process.env.REACT_APP_API_CHAT_URL,{accessTokenFactory:function accessTokenFactory(){return _this4.rootStore.commonStore.token;}}).configureLogging(LogLevel.Information).build();_this4.hubConnection.start().then(function(){return console.log(_this4.hubConnection.state);}).catch(function(error){return console.log(\"Error establishing connection : \",error);});_this4.hubConnection.on('ReceiveComment',function(comment){runInAction(function(){_this4.activity.comments.push(comment);});});};}}),_descriptor14=_applyDecoratedDescriptor(_class.prototype,\"stopHubConnection\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this5=this;return function(){_this5.hubConnection.stop();};}}),_descriptor15=_applyDecoratedDescriptor(_class.prototype,\"addComment\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this6=this;return/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(values){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:values.activityId=_this6.activity.id;_context.prev=1;_context.next=4;return _this6.hubConnection.invoke('SendComment',values);case 4:_context.next=9;break;case 6:_context.prev=6;_context.t0=_context[\"catch\"](1);console.error(_context.t0);case 9:case\"end\":return _context.stop();}}},_callee,null,[[1,6]]);}));return function(_x){return _ref.apply(this,arguments);};}();}}),_applyDecoratedDescriptor(_class.prototype,\"activitiesByDate\",[computed],Object.getOwnPropertyDescriptor(_class.prototype,\"activitiesByDate\"),_class.prototype),_descriptor16=_applyDecoratedDescriptor(_class.prototype,\"loadActivities\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this7=this;return/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var activitiesEnvelope,activities,activityCount;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_this7.loadingInitial=true;_context2.prev=1;_context2.next=4;return agent.Activities.list(_this7.axiosParams);case 4:activitiesEnvelope=_context2.sent;activities=activitiesEnvelope.activities,activityCount=activitiesEnvelope.activityCount;runInAction(\"loading activities\",function(){activities.forEach(function(activity){setActivityProps(activity,_this7.rootStore.userStore.user);_this7.activityRegistry.set(activity.id,activity);});_this7.activityCount=activityCount;_this7.loadingInitial=false;});_context2.next=12;break;case 9:_context2.prev=9;_context2.t0=_context2[\"catch\"](1);runInAction(\"load activities error\",function(){_this7.loadingInitial=false;});case 12:case\"end\":return _context2.stop();}}},_callee2,null,[[1,9]]);}));}}),_descriptor17=_applyDecoratedDescriptor(_class.prototype,\"loadActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this8=this;return/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(id){var activity;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:activity=_this8.getActivity(id);if(!activity){_context3.next=6;break;}_this8.activity=activity;return _context3.abrupt(\"return\",toJS(activity));case 6:_this8.loadingInitial=true;_context3.prev=7;_context3.next=10;return agent.Activities.details(id);case 10:activity=_context3.sent;runInAction(\"getting activity\",function(){setActivityProps(activity,_this8.rootStore.userStore.user);_this8.activity=activity;_this8.activityRegistry.set(activity.id,activity);_this8.loadingInitial=false;});return _context3.abrupt(\"return\",activity);case 15:_context3.prev=15;_context3.t0=_context3[\"catch\"](7);runInAction(\"get activity error\",function(){_this8.loadingInitial=false;});console.log(_context3.t0);case 19:case\"end\":return _context3.stop();}}},_callee3,null,[[7,15]]);}));return function(_x2){return _ref3.apply(this,arguments);};}();}}),_descriptor18=_applyDecoratedDescriptor(_class.prototype,\"clearActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this9=this;return function(){_this9.activity=null;};}}),_descriptor19=_applyDecoratedDescriptor(_class.prototype,\"createActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this10=this;return/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(activity){var attendee,attendees;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_this10.submitting=true;_context4.prev=1;_context4.next=4;return agent.Activities.create(activity);case 4:attendee=createAttendee(_this10.rootStore.userStore.user);attendee.isHost=true;attendees=[];attendees.push(attendee);activity.attendees=attendees;activity.comments=[];activity.isHost=true;runInAction(\"create activity\",function(){_this10.activityRegistry.set(activity.id,activity);_this10.submitting=false;});history.push(\"/activities/\".concat(activity.id));_context4.next=20;break;case 15:_context4.prev=15;_context4.t0=_context4[\"catch\"](1);runInAction(\"create activity error\",function(){_this10.submitting=false;});toast.error(\"Problem submitting data\");console.log(_context4.t0.response);case 20:case\"end\":return _context4.stop();}}},_callee4,null,[[1,15]]);}));return function(_x3){return _ref4.apply(this,arguments);};}();}}),_descriptor20=_applyDecoratedDescriptor(_class.prototype,\"editActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this11=this;return/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(activity){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_this11.submitting=true;_context5.prev=1;_context5.next=4;return agent.Activities.update(activity);case 4:runInAction(\"editing activity\",function(){_this11.activityRegistry.set(activity.id,activity);_this11.activity=activity;_this11.submitting=false;});history.push(\"/activities/\".concat(activity.id));_context5.next=13;break;case 8:_context5.prev=8;_context5.t0=_context5[\"catch\"](1);runInAction(\"edit activity error\",function(){_this11.submitting=false;});toast.error(\"Problem submitting data\");console.log(_context5.t0);case 13:case\"end\":return _context5.stop();}}},_callee5,null,[[1,8]]);}));return function(_x4){return _ref5.apply(this,arguments);};}();}}),_descriptor21=_applyDecoratedDescriptor(_class.prototype,\"deleteActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this12=this;return/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(event,id){return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_this12.submitting=true;_this12.target=event.currentTarget.name;_context6.prev=2;_context6.next=5;return agent.Activities.delete(id);case 5:runInAction(\"deleting activity\",function(){_this12.activityRegistry.delete(id);_this12.submitting=false;_this12.target=\"\";});_context6.next=12;break;case 8:_context6.prev=8;_context6.t0=_context6[\"catch\"](2);runInAction(\"delete activity error\",function(){_this12.submitting=false;_this12.target=\"\";});console.log(_context6.t0);case 12:case\"end\":return _context6.stop();}}},_callee6,null,[[2,8]]);}));return function(_x5,_x6){return _ref6.apply(this,arguments);};}();}}),_descriptor22=_applyDecoratedDescriptor(_class.prototype,\"attendActivity\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this13=this;return/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){var attendee;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:attendee=createAttendee(_this13.rootStore.userStore.user);_this13.loading=true;_context7.prev=2;_context7.next=5;return agent.Activities.attend(_this13.activity.id);case 5:runInAction(function(){if(_this13.activity){_this13.activity.attendees.push(attendee);_this13.activity.isGoing=true;_this13.activityRegistry.set(_this13.activity.id,_this13.activity);_this13.loading=false;}});_context7.next=12;break;case 8:_context7.prev=8;_context7.t0=_context7[\"catch\"](2);runInAction(function(){_this13.loading=false;});toast.error(\"Problem signing up to activity\");case 12:case\"end\":return _context7.stop();}}},_callee7,null,[[2,8]]);}));}}),_descriptor23=_applyDecoratedDescriptor(_class.prototype,\"cancelAttendance\",[action],{configurable:true,enumerable:true,writable:true,initializer:function initializer(){var _this14=this;return/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_this14.loading=true;_context8.prev=1;_context8.next=4;return agent.Activities.unattend(_this14.activity.id);case 4:runInAction(function(){if(_this14.activity){_this14.activity.attendees=_this14.activity.attendees.filter(function(a){return a.userName!==_this14.rootStore.userStore.user.username;});_this14.activity.isGoing=false;_this14.activityRegistry.set(_this14.activity.id,_this14.activity);_this14.loading=false;}});_context8.next=11;break;case 7:_context8.prev=7;_context8.t0=_context8[\"catch\"](1);runInAction(function(){_this14.loading=false;});toast.error(\"Problem cancelling activity\");case 11:case\"end\":return _context8.stop();}}},_callee8,null,[[1,7]]);}));}})),_class));export{ActivityStore as default};","map":{"version":3,"sources":["C:/Projects/Reactivities/client-app/src/app/stores/activityStore.ts"],"names":["observable","action","computed","runInAction","reaction","toJS","agent","history","toast","setActivityProps","createAttendee","HubConnectionBuilder","LogLevel","LIMIT","ActivityStore","ref","rootStore","getActivity","id","activityRegistry","get","predicate","keys","page","clear","loadActivities","activities","sortedActivities","sort","a","b","date","getTime","Object","entries","reduce","activity","toISOString","split","params","URLSearchParams","append","String","forEach","value","key","Math","ceil","activityCount","groupActivitiesByDate","Array","from","values","Map","set","hubConnection","withUrl","process","env","REACT_APP_API_CHAT_URL","accessTokenFactory","commonStore","token","configureLogging","Information","build","start","then","console","log","state","catch","error","on","comment","comments","push","stop","activityId","invoke","loadingInitial","Activities","list","axiosParams","activitiesEnvelope","userStore","user","details","submitting","create","attendee","isHost","attendees","response","update","event","target","currentTarget","name","delete","loading","attend","isGoing","unattend","filter","userName","username"],"mappings":"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","sourcesContent":["import { observable, action, computed, runInAction, reaction, toJS } from \"mobx\";\r\nimport { SyntheticEvent } from \"react\";\r\nimport { IActivity } from \"../models/activity\";\r\nimport agent from \"../api/agent\";\r\nimport { history } from \"../..\";\r\nimport { toast } from \"react-toastify\";\r\nimport { RootStore } from \"./rootStore\";\r\nimport { setActivityProps, createAttendee } from \"../common/util/util\";\r\n\r\nimport { HubConnection, HubConnectionBuilder, LogLevel } from \"@aspnet/signalr\";\r\n\r\n\r\nconst LIMIT=2;\r\n;\r\nexport default class ActivityStore {\r\n  rootStore: RootStore;\r\n  constructor(rootStore: RootStore) {\r\n    this.rootStore = rootStore;\r\n\r\n    reaction(\r\n      ()=> this.predicate.keys(),\r\n      ()=> {\r\n        this.page=0;\r\n        this.activityRegistry.clear();\r\n        this.loadActivities();\r\n      }\r\n    )\r\n  }\r\n\r\n  @observable activityRegistry = new Map();\r\n  @observable activity: IActivity | null = null;\r\n  @observable loadingInitial = false;\r\n  @observable submitting = false;\r\n  @observable target = \"\";\r\n  @observable loading = false;\r\n  @observable.ref hubConnection: HubConnection | null = null;\r\n\r\n  @observable activityCount=0 ;\r\n  @observable page=0 ;\r\n  @observable predicate=new Map();\r\n\r\n\r\n  @action setPredicate =(predicate: string,value: string | Date) => {\r\n    this.predicate.clear();\r\n    if (predicate !=='all') {\r\n      this.predicate.set(predicate,value);\r\n    }\r\n  }\r\n\r\n\r\n  @computed get axiosParams () {\r\n    const params =new  URLSearchParams();\r\n    params.append('limit',String(LIMIT));\r\n    params.append('offset',`${this.page ? this.page*LIMIT : 0}`);\r\n    this.predicate.forEach((value,key)=> {\r\n      if (key ==='startDate') {\r\n        params.append(key,value.toISOString());\r\n\r\n      }\r\n      else{\r\n        params.append(key,value);\r\n      }\r\n    })\r\n    return params;\r\n  }\r\n\r\n\r\n  @computed get totalPages () {\r\n    return Math.ceil(this.activityCount/LIMIT);\r\n  }\r\n  @action setPage = (page: number) => {\r\n    this.page =page;\r\n  }\r\n\r\n  @action createHubConnection = () => {\r\n    this.hubConnection = new HubConnectionBuilder()\r\n      .withUrl( process.env.REACT_APP_API_CHAT_URL!, {\r\n        accessTokenFactory: () => this.rootStore.commonStore.token!,\r\n      })\r\n      .configureLogging(LogLevel.Information)\r\n      .build();\r\n    this.hubConnection\r\n      .start()\r\n      .then(() => console.log(this.hubConnection!.state))\r\n      .catch((error) => console.log(\"Error establishing connection : \", error));\r\n\r\n      this.hubConnection.on('ReceiveComment',comment => {\r\n        runInAction(() => {\r\n          this.activity!.comments.push(comment); \r\n        })\r\n      })\r\n  };\r\n\r\n  @action stopHubConnection = () => {\r\n    this.hubConnection!.stop();\r\n  }\r\n\r\n  @action addComment = async (values :any) => {\r\n    values.activityId=this.activity!.id;\r\n\r\n    try {\r\n      await this.hubConnection!.invoke('SendComment', values)\r\n    } catch (error) {\r\n      console.error(error);\r\n      \r\n    }\r\n  }\r\n\r\n  @computed get activitiesByDate() {\r\n    return this.groupActivitiesByDate(\r\n      Array.from(this.activityRegistry.values())\r\n    );\r\n  }\r\n\r\n  groupActivitiesByDate(activities: IActivity[]) {\r\n    const sortedActivities = activities.sort(\r\n      (a, b) => a.date.getTime() - b.date.getTime()\r\n    );\r\n    return Object.entries(\r\n      sortedActivities.reduce((activities, activity) => {\r\n        const date = activity.date.toISOString().split(\"T\")[0];\r\n        activities[date] = activities[date]\r\n          ? [...activities[date], activity]\r\n          : [activity];\r\n        return activities;\r\n      }, {} as { [key: string]: IActivity[] })\r\n    );\r\n  }\r\n\r\n  @action loadActivities = async () => {\r\n    this.loadingInitial = true;\r\n    try {\r\n      const activitiesEnvelope = await agent.Activities.list(this.axiosParams);\r\n      const {activities,activityCount} =activitiesEnvelope;\r\n      runInAction(\"loading activities\", () => {\r\n        activities.forEach((activity) => {\r\n          setActivityProps(activity, this.rootStore.userStore.user!);\r\n          this.activityRegistry.set(activity.id, activity);\r\n        });\r\n        this.activityCount=activityCount;\r\n        this.loadingInitial = false;\r\n      });\r\n    } catch (error) {\r\n      runInAction(\"load activities error\", () => {\r\n        this.loadingInitial = false;\r\n      });\r\n    }\r\n  };\r\n\r\n  @action loadActivity = async (id: string) => {\r\n    let activity = this.getActivity(id);\r\n    if (activity) {\r\n      this.activity = activity;\r\n      return toJS(activity);\r\n    } else {\r\n      this.loadingInitial = true;\r\n      try {\r\n        activity = await agent.Activities.details(id);\r\n        runInAction(\"getting activity\", () => {\r\n          setActivityProps(activity, this.rootStore.userStore.user!);\r\n          this.activity = activity;\r\n          this.activityRegistry.set(activity.id, activity);\r\n          this.loadingInitial = false;\r\n        });\r\n        return activity;\r\n      } catch (error) {\r\n        runInAction(\"get activity error\", () => {\r\n          this.loadingInitial = false;\r\n        });\r\n        console.log(error);\r\n      }\r\n    }\r\n  };\r\n\r\n  @action clearActivity = () => {\r\n    this.activity = null;\r\n  };\r\n\r\n  getActivity = (id: string) => {\r\n    return this.activityRegistry.get(id);\r\n  };\r\n\r\n  @action createActivity = async (activity: IActivity) => {\r\n    this.submitting = true;\r\n    try {\r\n      await agent.Activities.create(activity);\r\n      const attendee = createAttendee(this.rootStore.userStore.user!);\r\n      attendee.isHost = true;\r\n      let attendees = [];\r\n      attendees.push(attendee);\r\n      activity.attendees = attendees;\r\n      activity.comments=[];\r\n      activity.isHost = true;\r\n      runInAction(\"create activity\", () => {\r\n        this.activityRegistry.set(activity.id, activity);\r\n        this.submitting = false;\r\n      });\r\n      history.push(`/activities/${activity.id}`);\r\n    } catch (error) {\r\n      runInAction(\"create activity error\", () => {\r\n        this.submitting = false;\r\n      });\r\n      toast.error(\"Problem submitting data\");\r\n      console.log(error.response);\r\n    }\r\n  };\r\n\r\n  @action editActivity = async (activity: IActivity) => {\r\n    this.submitting = true;\r\n    try {\r\n      await agent.Activities.update(activity);\r\n      runInAction(\"editing activity\", () => {\r\n        this.activityRegistry.set(activity.id, activity);\r\n        this.activity = activity;\r\n        this.submitting = false;\r\n      });\r\n      history.push(`/activities/${activity.id}`);\r\n    } catch (error) {\r\n      runInAction(\"edit activity error\", () => {\r\n        this.submitting = false;\r\n      });\r\n      toast.error(\"Problem submitting data\");\r\n      console.log(error);\r\n    }\r\n  };\r\n\r\n  @action deleteActivity = async (\r\n    event: SyntheticEvent<HTMLButtonElement>,\r\n    id: string\r\n  ) => {\r\n    this.submitting = true;\r\n    this.target = event.currentTarget.name;\r\n    try {\r\n      await agent.Activities.delete(id);\r\n      runInAction(\"deleting activity\", () => {\r\n        this.activityRegistry.delete(id);\r\n        this.submitting = false;\r\n        this.target = \"\";\r\n      });\r\n    } catch (error) {\r\n      runInAction(\"delete activity error\", () => {\r\n        this.submitting = false;\r\n        this.target = \"\";\r\n      });\r\n      console.log(error);\r\n    }\r\n  };\r\n\r\n  @action attendActivity = async () => {\r\n    const attendee = createAttendee(this.rootStore.userStore.user!);\r\n    this.loading = true;\r\n    try {\r\n      await agent.Activities.attend(this.activity!.id);\r\n      runInAction(() => {\r\n        if (this.activity) {\r\n          this.activity.attendees.push(attendee);\r\n          this.activity.isGoing = true;\r\n          this.activityRegistry.set(this.activity.id, this.activity);\r\n          this.loading = false;\r\n        }\r\n      });\r\n    } catch (error) {\r\n      runInAction(() => {\r\n        this.loading = false;\r\n      });\r\n      toast.error(\"Problem signing up to activity\");\r\n    }\r\n  };\r\n  @action cancelAttendance = async () => {\r\n    this.loading = true;\r\n\r\n    try {\r\n      await agent.Activities.unattend(this.activity!.id);\r\n\r\n      runInAction(() => {\r\n        if (this.activity) {\r\n          this.activity.attendees = this.activity.attendees.filter(\r\n            (a) => a.userName !== this.rootStore.userStore.user!.username\r\n          );\r\n          this.activity.isGoing = false;\r\n          this.activityRegistry.set(this.activity.id, this.activity);\r\n          this.loading = false;\r\n        }\r\n      });\r\n    } catch (error) {\r\n      runInAction(() => {\r\n        this.loading = false;\r\n      });\r\n      toast.error(\"Problem cancelling activity\");\r\n    }\r\n  };\r\n}\r\n"]},"metadata":{},"sourceType":"module"}