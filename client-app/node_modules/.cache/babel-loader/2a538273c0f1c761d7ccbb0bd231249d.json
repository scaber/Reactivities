{"ast":null,"code":"/**\n * @ag-grid-community/core - Advanced Data Grid / Data Table supporting Javascript / React / AngularJS / Web Components\n * @version v22.1.1\n * @link http://www.ag-grid.com/\n * @license MIT\n */\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nimport { Autowired, Bean, PostConstruct } from \"../context/context\";\nimport { Events } from \"../eventKeys\";\nimport { FillUndoRedoAction, UndoRedoAction, UndoRedoStack } from \"./undoRedoStack\";\nimport { Constants } from \"../constants\";\nimport { ModuleNames } from \"../modules/moduleNames\";\nimport { ModuleRegistry } from \"../modules/moduleRegistry\";\n\nvar UndoRedoService =\n/** @class */\nfunction () {\n  function UndoRedoService() {\n    var _this = this;\n\n    this.cellValueChanges = [];\n    this.isCellEditing = false;\n    this.isRowEditing = false;\n    this.isPasting = false;\n    this.isFilling = false;\n\n    this.onCellValueChanged = function (event) {\n      var shouldCaptureAction = _this.isCellEditing || _this.isRowEditing || _this.isPasting || _this.isFilling;\n\n      if (!shouldCaptureAction) {\n        return;\n      }\n\n      var rowPinned = event.rowPinned,\n          rowIndex = event.rowIndex,\n          column = event.column,\n          oldValue = event.oldValue,\n          value = event.value;\n      var cellValueChange = {\n        rowPinned: rowPinned,\n        rowIndex: rowIndex,\n        columnId: column.getColId(),\n        oldValue: oldValue,\n        newValue: value\n      };\n\n      _this.cellValueChanges.push(cellValueChange);\n    };\n\n    this.clearStacks = function () {\n      _this.undoStack.clear();\n\n      _this.redoStack.clear();\n    };\n  }\n\n  UndoRedoService.prototype.init = function () {\n    if (!this.gridOptionsWrapper.isUndoRedoCellEditing()) {\n      return;\n    }\n\n    var undoRedoLimit = this.gridOptionsWrapper.getUndoRedoCellEditingLimit();\n\n    if (undoRedoLimit <= 0) {\n      return;\n    }\n\n    this.undoStack = new UndoRedoStack(undoRedoLimit);\n    this.redoStack = new UndoRedoStack(undoRedoLimit);\n    this.addRowEditingListeners();\n    this.addCellEditingListeners();\n    this.addPasteListeners();\n    this.addFillListeners();\n    this.eventService.addEventListener(Events.EVENT_CELL_VALUE_CHANGED, this.onCellValueChanged); // undo / redo is restricted to actual editing so we clear the stacks when other operations are\n    // performed that change the order of the row / cols.\n\n    this.eventService.addEventListener(Events.EVENT_MODEL_UPDATED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_PIVOT_MODE_CHANGED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_EVERYTHING_CHANGED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_GROUP_OPENED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_ROW_GROUP_CHANGED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_MOVED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_PINNED, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_COLUMN_VISIBLE, this.clearStacks);\n    this.eventService.addEventListener(Events.EVENT_ROW_DRAG_END, this.clearStacks);\n  };\n\n  UndoRedoService.prototype.undo = function () {\n    if (!this.undoStack) {\n      return;\n    }\n\n    var undoAction = this.undoStack.pop();\n\n    if (!undoAction || !undoAction.cellValueChanges) {\n      return;\n    }\n\n    this.processAction(undoAction, function (cellValueChange) {\n      return cellValueChange.oldValue;\n    });\n\n    if (undoAction instanceof FillUndoRedoAction) {\n      this.processRangeAndCellFocus(undoAction.cellValueChanges, undoAction.initialRange);\n    } else {\n      this.processRangeAndCellFocus(undoAction.cellValueChanges);\n    }\n\n    this.redoStack.push(undoAction);\n  };\n\n  UndoRedoService.prototype.redo = function () {\n    if (!this.redoStack) {\n      return;\n    }\n\n    var redoAction = this.redoStack.pop();\n\n    if (!redoAction || !redoAction.cellValueChanges) {\n      return;\n    }\n\n    this.processAction(redoAction, function (cellValueChange) {\n      return cellValueChange.newValue;\n    });\n\n    if (redoAction instanceof FillUndoRedoAction) {\n      this.processRangeAndCellFocus(redoAction.cellValueChanges, redoAction.finalRange);\n    } else {\n      this.processRangeAndCellFocus(redoAction.cellValueChanges);\n    }\n\n    this.undoStack.push(redoAction);\n  };\n\n  UndoRedoService.prototype.processAction = function (action, valueExtractor) {\n    var _this = this;\n\n    action.cellValueChanges.forEach(function (cellValueChange) {\n      var rowIndex = cellValueChange.rowIndex,\n          rowPinned = cellValueChange.rowPinned,\n          columnId = cellValueChange.columnId;\n      var rowPosition = {\n        rowIndex: rowIndex,\n        rowPinned: rowPinned\n      };\n\n      var currentRow = _this.getRowNode(rowPosition); // checks if the row has been filtered out\n\n\n      if (currentRow.rowTop == null) {\n        return;\n      }\n\n      currentRow.setDataValue(columnId, valueExtractor(cellValueChange));\n    });\n  };\n\n  UndoRedoService.prototype.processRangeAndCellFocus = function (cellValueChanges, range) {\n    if (range) {\n      var startRow = range.startRow;\n      var endRow = range.endRow;\n      var lastFocusedCell_1 = {\n        rowPinned: startRow.rowPinned,\n        rowIndex: startRow.rowIndex,\n        columnId: range.startColumn.getColId()\n      };\n      this.setLastFocusedCell(lastFocusedCell_1);\n      var cellRangeParams = {\n        rowStartIndex: startRow.rowIndex,\n        rowStartPinned: startRow.rowPinned,\n        rowEndIndex: endRow.rowIndex,\n        rowEndPinned: endRow.rowPinned,\n        columnStart: range.startColumn,\n        columns: range.columns\n      };\n      this.gridApi.addCellRange(cellRangeParams);\n      return;\n    }\n\n    var cellValueChange = cellValueChanges[0];\n    var rowIndex = cellValueChange.rowIndex,\n        rowPinned = cellValueChange.rowPinned;\n    var rowPosition = {\n      rowIndex: rowIndex,\n      rowPinned: rowPinned\n    };\n    var row = this.getRowNode(rowPosition);\n    var lastFocusedCell = {\n      rowPinned: cellValueChange.rowPinned,\n      rowIndex: row.rowIndex,\n      columnId: cellValueChange.columnId\n    };\n    this.setLastFocusedCell(lastFocusedCell);\n  };\n\n  UndoRedoService.prototype.setLastFocusedCell = function (lastFocusedCell) {\n    var rowIndex = lastFocusedCell.rowIndex,\n        columnId = lastFocusedCell.columnId,\n        rowPinned = lastFocusedCell.rowPinned;\n    this.gridApi.ensureIndexVisible(rowIndex);\n    this.gridApi.ensureColumnVisible(columnId);\n\n    if (ModuleRegistry.isRegistered(ModuleNames.RangeSelectionModule)) {\n      this.gridApi.clearRangeSelection();\n    }\n\n    this.focusedCellController.setFocusedCell(rowIndex, columnId, rowPinned, true);\n  };\n\n  UndoRedoService.prototype.addRowEditingListeners = function () {\n    var _this = this;\n\n    this.eventService.addEventListener(Events.EVENT_ROW_EDITING_STARTED, function () {\n      _this.isRowEditing = true;\n    });\n    this.eventService.addEventListener(Events.EVENT_ROW_EDITING_STOPPED, function () {\n      var action = new UndoRedoAction(_this.cellValueChanges);\n\n      _this.pushActionsToUndoStack(action);\n\n      _this.isRowEditing = false;\n    });\n  };\n\n  UndoRedoService.prototype.addCellEditingListeners = function () {\n    var _this = this;\n\n    this.eventService.addEventListener(Events.EVENT_CELL_EDITING_STARTED, function () {\n      _this.isCellEditing = true;\n    });\n    this.eventService.addEventListener(Events.EVENT_CELL_EDITING_STOPPED, function () {\n      _this.isCellEditing = false;\n      var shouldPushAction = !_this.isRowEditing && !_this.isPasting && !_this.isFilling;\n\n      if (shouldPushAction) {\n        var action = new UndoRedoAction(_this.cellValueChanges);\n\n        _this.pushActionsToUndoStack(action);\n      }\n    });\n  };\n\n  UndoRedoService.prototype.addPasteListeners = function () {\n    var _this = this;\n\n    this.eventService.addEventListener(Events.EVENT_PASTE_START, function () {\n      _this.isPasting = true;\n    });\n    this.eventService.addEventListener(Events.EVENT_PASTE_END, function () {\n      var action = new UndoRedoAction(_this.cellValueChanges);\n\n      _this.pushActionsToUndoStack(action);\n\n      _this.isPasting = false;\n    });\n  };\n\n  UndoRedoService.prototype.addFillListeners = function () {\n    var _this = this;\n\n    this.eventService.addEventListener(Events.EVENT_FILL_START, function () {\n      _this.isFilling = true;\n    });\n    this.eventService.addEventListener(Events.EVENT_FILL_END, function (event) {\n      var action = new FillUndoRedoAction(_this.cellValueChanges, event.initialRange, event.finalRange);\n\n      _this.pushActionsToUndoStack(action);\n\n      _this.isFilling = false;\n    });\n  };\n\n  UndoRedoService.prototype.pushActionsToUndoStack = function (action) {\n    this.undoStack.push(action);\n    this.cellValueChanges = [];\n    this.redoStack.clear();\n  };\n\n  UndoRedoService.prototype.getRowNode = function (gridRow) {\n    switch (gridRow.rowPinned) {\n      case Constants.PINNED_TOP:\n        return this.pinnedRowModel.getPinnedTopRowData()[gridRow.rowIndex];\n\n      case Constants.PINNED_BOTTOM:\n        return this.pinnedRowModel.getPinnedBottomRowData()[gridRow.rowIndex];\n\n      default:\n        return this.rowModel.getRow(gridRow.rowIndex);\n    }\n  };\n\n  __decorate([Autowired('gridOptionsWrapper')], UndoRedoService.prototype, \"gridOptionsWrapper\", void 0);\n\n  __decorate([Autowired('focusedCellController')], UndoRedoService.prototype, \"focusedCellController\", void 0);\n\n  __decorate([Autowired('eventService')], UndoRedoService.prototype, \"eventService\", void 0);\n\n  __decorate([Autowired('gridApi')], UndoRedoService.prototype, \"gridApi\", void 0);\n\n  __decorate([Autowired('rowModel')], UndoRedoService.prototype, \"rowModel\", void 0);\n\n  __decorate([Autowired('pinnedRowModel')], UndoRedoService.prototype, \"pinnedRowModel\", void 0);\n\n  __decorate([PostConstruct], UndoRedoService.prototype, \"init\", null);\n\n  UndoRedoService = __decorate([Bean('undoRedoService')], UndoRedoService);\n  return UndoRedoService;\n}();\n\nexport { UndoRedoService };","map":null,"metadata":{},"sourceType":"module"}